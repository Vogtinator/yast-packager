#! /bin/bash
#
# This is an agent for the access to the the installation
# medium. It can mount and unmount a cd, read the number
# and release number of the mounted cd.
#

exec 2>/dev/null

while true ; do
    IFS=
    read COMMAND || exit
    unset IFS

    case "$COMMAND" in
	"result ("*)
	    exit
	    ;;
	"Read (.cdnum."*)
	    cdnum=$(echo $COMMAND | sed -n -e 's/Read (.cdnum.\([0123456789]*\).*/\1/gp')
	    path=$(echo $COMMAND | sed -e 's/\Read (.cdnum.[0123456789]*,[ ]*"//' -e 's/".$//')
	    cd $path
 	    NUMFILE=$(ls .*-disk-00$cdnum.* | head -1)
	    if [ -z "$NUMFILE" -o ! -r "$NUMFILE" ] ; then
		NUMFILE=$(ls .*-disk-00?.* | head -1)
		if [ -z "$NUMFILE" -o ! -r "$NUMFILE" ] ; then
		    echo "nil";
		else
		    echo "$NUMFILE" | sed 's/.*-disk-0*\([0-9]\+\)\..*/\1/'
		fi
	    else
		echo "$NUMFILE" | sed 's/.*-disk-0*\([0-9]\+\)\..*/\1/'
            fi
	    cd /
	    ;;
        "Read (.cdrelease,"*)
	    path=$(echo $COMMAND | sed -e 's/\Read (.cdrelease,[ ]*"//' -e 's/".$//')
	    cd $path
 	    NUMFILE=$(ls .*-disk-???.* | head -1)
	    if [ -z "$NUMFILE" -o ! -r "$NUMFILE" ] ; then
		echo "nil";
	    else
		echo "$NUMFILE" | sed 's/.*-disk-0*[0-9]\+\.\([0-9]*\)/\1/'
	    fi
	    cd /
	    ;;
        "Read (.product,"*)
	    path=$(echo $COMMAND | sed -e 's/\Read (.product,[ ]*"//' -e 's/".$//')
	    cd $path
 	    NUMFILE=$(ls .*-disk-???.* | head -1)
	    if [ -z "$NUMFILE" -o ! -r "$NUMFILE" ] ; then
		echo "nil";
	    else
		product=$(cat "$NUMFILE" | grep -v "dedicated to you :)")
		echo \"${product}\"
	    fi
	    cd /
	    ;;
        "Dir ("*)
            echo "[]"
	    ;;

	*)
	    echo "nil"
	    ;;
    esac
done
